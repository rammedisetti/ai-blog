{% load ecommerce_tags %}
{% if products %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
  {% for product in products %}
  <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-white/10 via-white/5 to-transparent p-1 shadow-2xl transition duration-300 {% if product.is_active %}hover:-translate-y-1 hover:shadow-indigo-600/40{% else %}opacity-70{% endif %}">
    <div class="absolute inset-0">
      <div class="h-full w-full bg-[radial-gradient(circle_at_top,_rgba(129,140,248,0.25),_transparent_55%)]"></div>
    </div>
    <div class="relative flex h-full flex-col gap-4 rounded-[26px] bg-slate-900/60 p-5 backdrop-blur">
      <div class="relative overflow-hidden rounded-2xl">
        <img
          src="{{ product.thumbnail.url }}"
          alt="{{ product.name }}"
          class="h-52 w-full object-cover lazyload ring-1 ring-white/10"
          loading="lazy"
        >
        <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/80 via-transparent"></div>
        <div class="absolute inset-x-0 top-0 flex items-center justify-between px-4 py-3 text-xs font-semibold">
          <span class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-indigo-600/90 via-purple-600/90 to-pink-600/90 px-3 py-1.5 text-white shadow-lg shadow-indigo-900/50 backdrop-blur-sm ring-1 ring-white/20">
            <span class="h-2 w-2 rounded-full bg-lime-400 shadow-sm shadow-lime-400/50"></span>
            {{ product.category|default:'Collection' }}
          </span>
          {% if product.is_free %}
            <span class="rounded-full bg-emerald-400/90 px-3 py-1 text-slate-900">Free</span>
          {% elif not product.is_active %}
            <span class="rounded-full bg-orange-400/90 px-3 py-1 text-slate-900">Inactive</span>
          {% endif %}
        </div>
      </div>

      <div class="space-y-2">
        <h2 class="text-xl font-semibold text-white line-clamp-2">{{ product.name }}</h2>
        <p class="text-sm text-slate-300 line-clamp-3">{{ product.description|truncatechars:140 }}</p>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-baseline gap-2 text-white">
          {% if product.is_free %}
            {% if product.price %}
              <span class="text-xs text-slate-400 line-through">₹{{ product.price }}</span>
            {% endif %}
            <span class="text-2xl font-black text-emerald-300">Free</span>
          {% else %}
            {% if product.discount_price %}
              <span class="bg-gradient-to-r from-indigo-400 to-pink-400 bg-clip-text text-3xl font-black text-transparent">₹{{ product.discount_price }}</span>
              <span class="text-xs text-slate-400 line-through">₹{{ product.price }}</span>
            {% else %}
              <span class="bg-gradient-to-r from-sky-400 to-violet-400 bg-clip-text text-3xl font-black text-transparent">₹{{ product.price }}</span>
            {% endif %}
          {% endif %}
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-300">
          <span class="inline-flex items-center gap-1 rounded-full border border-white/10 px-2 py-1">
            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h3m0 0l3 3m-3-3l3-3m12 3h-3m0 0l-3 3m3-3l-3-3M9 6l3-3 3 3m0 12l-3 3-3-3" /></svg>
            {{ product.actual_downloads|default:0 }} downloads
          </span>
        </div>
      </div>

      {% if product.tags %}
      <div class="flex flex-wrap gap-2 text-xs uppercase tracking-wide text-slate-400">
        {% with tags=product.tags|split:"," %}
          {% for tag in tags %}
            <span class="rounded-full bg-white/5 px-3 py-1 text-white/80">{{ tag|default_if_none:'' }}</span>
          {% endfor %}
        {% endwith %}
      </div>
      {% endif %}

      <div class="mt-auto grid grid-cols-1 gap-3 md:grid-cols-2">
        {% if product.is_active %}
          <a href="{% url 'ecommerce:product_detail' product.slug %}" class="inline-flex items-center justify-center rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-indigo-300">Explore</a>
          <form method="post" action="{% url 'ecommerce:add_to_cart' product.product_id %}">
            {% csrf_token %}
            <button type="submit" class="inline-flex w-full items-center justify-center rounded-2xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-900/40 hover:from-indigo-400 hover:to-pink-400 focus:outline-none focus:ring-2 focus:ring-pink-400">Add to cart</button>
          </form>
        {% else %}
          <span class="col-span-2 inline-flex items-center justify-center rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-400" aria-disabled="true">Unavailable</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="rounded-3xl border border-white/10 bg-white/5 p-10 text-center text-white">
  <p class="text-lg font-semibold">We couldn't find any products matching these filters.</p>
  <p class="text-sm text-slate-300 mt-2">Adjust your search or clear filters to explore the full catalog.</p>
</div>
{% endif %}

{% if paginator.num_pages > 1 %}
<nav class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mt-10" aria-label="Pagination">
  {% with query=base_querystring %}
  <div>
    {% if page_obj.has_previous %}
    <a
      href="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ page_obj.previous_page_number }}"
      hx-get="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ page_obj.previous_page_number }}"
      hx-target="#catalog-results"
      hx-push-url="true"
      class="inline-flex items-center rounded-2xl border border-white/20 px-4 py-2 text-sm font-semibold text-white hover:border-white/40"
    >
      Previous
    </a>
    {% endif %}
  </div>
  <ul class="flex items-center gap-2 text-white">
    {% for num in paginator.page_range %}
      {% if num == page_obj.number %}
        <li>
          <span class="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-indigo-500 to-pink-500 px-4 py-2 text-sm font-semibold">{{ num }}</span>
        </li>
      {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
        <li>
          <a
            href="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ num }}"
            hx-get="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ num }}"
            hx-target="#catalog-results"
            hx-push-url="true"
            class="inline-flex items-center justify-center rounded-2xl border border-white/20 px-4 py-2 text-sm font-semibold text-white hover:border-white/40"
          >
            {{ num }}
          </a>
        </li>
      {% elif num == 1 or num == paginator.num_pages %}
        <li>
          <a
            href="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ num }}"
            hx-get="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ num }}"
            hx-target="#catalog-results"
            hx-push-url="true"
            class="inline-flex items-center justify-center rounded-2xl border border-white/20 px-4 py-2 text-sm font-semibold text-white hover:border-white/40"
          >
            {{ num }}
          </a>
        </li>
        {% if num == 1 and page_obj.number > 4 %}
        <li><span class="px-2 text-slate-400">…</span></li>
        {% elif num == paginator.num_pages and page_obj.number < paginator.num_pages|add:'-3' %}
        <li><span class="px-2 text-slate-400">…</span></li>
        {% endif %}
      {% endif %}
    {% endfor %}
  </ul>
  <div>
    {% if page_obj.has_next %}
    <a
      href="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ page_obj.next_page_number }}"
      hx-get="{{ request.path }}?{% if query %}{{ query }}&{% endif %}page={{ page_obj.next_page_number }}"
      hx-target="#catalog-results"
      hx-push-url="true"
      class="inline-flex items-center rounded-2xl border border-white/20 px-4 py-2 text-sm font-semibold text-white hover:border-white/40"
    >
      Next
    </a>
    {% endif %}
  </div>
  {% endwith %}
</nav>
{% endif %}
